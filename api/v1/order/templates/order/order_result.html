{% extends "base.html" %}
{% load static %}

{% block title %} 訂單詳情 {% endblock %}

{% block extra_css %}
<style>
/* 訂單結果頁面樣式 */
.order-result-container {
  min-height: 100vh;
  background: linear-gradient(135deg, #0c4128 0%, #1a5e3a 100%);
  padding: 80px 0 40px;
}

.order-card {
  background: rgba(255,255,255,0.95);
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.1);
  padding: 40px;
  margin: 20px 0;
  backdrop-filter: blur(10px);
}

.order-header {
  text-align: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #cda45e;
}

.order-number {
  color: #0c4128;
  font-size: 1.8rem;
  font-weight: bold;
  margin-bottom: 10px;
}

.order-status {
  display: inline-block;
  padding: 8px 20px;
  border-radius: 25px;
  font-weight: bold;
  text-transform: uppercase;
  font-size: 0.9rem;
  margin-bottom: 20px;
}

.status-pending {
  background: #ffeaa7;
  color: #d63031;
}

.status-paid {
  background: #55efc4;
  color: #00b894;
}

.status-processing {
  background: #74b9ff;
  color: #0984e3;
}

.status-shipped {
  background: #fd79a8;
  color: #e84393;
}

.status-completed {
  background: #00b894;
  color: #fff;
}

.order-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.info-item {
  background: rgba(12,65,40,0.05);
  padding: 15px;
  border-radius: 10px;
  border-left: 4px solid #cda45e;
}

.info-label {
  color: #666;
  font-size: 0.9rem;
  margin-bottom: 5px;
}

.info-value {
  color: #0c4128;
  font-weight: bold;
  font-size: 1.1rem;
}

.order-items {
  margin: 30px 0;
}

.item-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 0;
  border-bottom: 1px solid #eee;
}

.item-info {
  flex: 1;
}

.item-name {
  font-weight: bold;
  color: #0c4128;
  margin-bottom: 5px;
}

.item-details {
  color: #666;
  font-size: 0.9rem;
}

.item-quantity {
  font-weight: bold;
  color: #cda45e;
  margin: 0 20px;
}

.item-price {
  font-weight: bold;
  color: #0c4128;
  font-size: 1.1rem;
}

.order-total {
  background: rgba(12,65,40,0.05);
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
}

.total-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.total-final {
  font-size: 1.3rem;
  font-weight: bold;
  color: #0c4128;
  padding-top: 10px;
  border-top: 2px solid #cda45e;
}

.action-buttons {
  text-align: center;
  margin-top: 30px;
}

.btn-payment {
  background: linear-gradient(135deg, #cda45e 0%, #b8941f 100%);
  color: #fff;
  border: none;
  padding: 15px 40px;
  border-radius: 50px;
  font-weight: bold;
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-block;
  margin: 0 10px;
  box-shadow: 0 5px 15px rgba(205,164,94,0.3);
}

.btn-payment:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(205,164,94,0.4);
  color: #fff;
}

.btn-payment.disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-secondary {
  background: transparent;
  color: #0c4128;
  border: 2px solid #0c4128;
  padding: 13px 40px;
  border-radius: 50px;
  font-weight: bold;
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-block;
  margin: 0 10px;
}

.btn-secondary:hover {
  background: #0c4128;
  color: #fff;
}

.alert-info {
  background: #e3f2fd;
  border: 1px solid #2196f3;
  color: #1976d2;
  padding: 15px;
  border-radius: 10px;
  margin: 20px 0;
}

.payment-info {
  background: rgba(255,193,7,0.1);
  border: 1px solid #ffc107;
  color: #856404;
  padding: 15px;
  border-radius: 10px;
  margin: 20px 0;
  text-align: center;
}

@media (max-width: 768px) {
  .order-card {
    padding: 20px;
    margin: 10px;
  }
  
  .order-info {
    grid-template-columns: 1fr;
  }
  
  .item-row {
    flex-direction: column;
    align-items: flex-start;
    text-align: left;
  }
  
  .item-quantity, .item-price {
    margin: 5px 0;
  }
  
  .btn-payment, .btn-secondary {
    display: block;
    margin: 10px 0;
    width: 100%;
  }
}
</style>
{% endblock %}

{% block content %}


<main class="main">
    <!-- Page Title -->
    <div class="page-title cart-hero position-relative" data-aos="fade">
      <div class="container position-relative">
        <h1 class="text-light text-center">購物車</h1>
        <p class="text-center text-light fs-5">檢視您選購的商品</p>
        <nav class="breadcrumbs">
          <ol>
            <li><a href="/">首頁</a></li>
            <li class="current">購物車</li>
          </ol>
        </nav>
      </div>
    </div><!-- End Page Title -->

    <!-- 購物車內容 -->
    <section class="section py-5">
        <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="order-card">
          <div class="order-header">
            <div class="order-number">訂單編號：{{ order.merchant_trade_no }}</div>
            <div class="order-status status-{{ order.status }}">
              {% if order.status == 'pending' %}
                待付款
              {% elif order.status == 'paid' %}
                已付款
              {% elif order.status == 'processing' %}
                處理中
              {% elif order.status == 'shipped' %}
                已出貨
              {% elif order.status == 'completed' %}
                已完成
              {% elif order.status == 'cancelled' %}
                已取消
              {% else %}
                {{ order.status }}
              {% endif %}
            </div>
            <div class="text-muted">
              訂單創建時間：{{ order.created_at|date:"Y年m月d日 H:i" }}
            </div>
          </div>
          
          <div class="order-info">
            <div class="info-item">
              <div class="info-label">收件人</div>
              <div class="info-value">
                {% if order.user.profile and order.user.profile.real_name %}
                  {{ order.user.profile.real_name }}
                {% elif order.user.profile and order.user.profile.nickname %}
                  {{ order.user.profile.nickname }}
                {% else %}
                  {{ order.user.email }}
                {% endif %}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">聯絡電話</div>
              <div class="info-value">
                {% if order.user.profile and order.user.profile.phone %}
                  {{ order.user.profile.phone }}
                {% else %}
                  尚未提供
                {% endif %}
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">電子郵件</div>
              <div class="info-value">{{ order.user.email }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">訂單狀態</div>
              <div class="info-value">
                {% if order.status == 'pending' %}
                  等待付款中
                {% elif order.status == 'paid' %}
                  付款成功
                {% elif order.status == 'processing' %}
                  訂單處理中
                {% elif order.status == 'shipped' %}
                  商品已出貨
                {% elif order.status == 'completed' %}
                  訂單已完成
                {% elif order.status == 'cancelled' %}
                  訂單已取消
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="order-items">
            <h4 style="color: #0c4128; margin-bottom: 20px;">
              <i class="bi bi-bag-check"></i> 訂單明細
            </h4>
            {% for item in order.items.all %}
            <div class="item-row">
              <div class="item-info">
                <div class="item-name">{{ item.product.name }}</div>
                <div class="item-details">
                  單價：NT$ {{ item.price|floatformat:0 }} | 
                  {% if item.product.vendor %}
                    小農：{{ item.product.vendor.name }}
                  {% endif %}
                </div>
              </div>
              <div class="item-quantity">x {{ item.quantity }}</div>
              <div class="item-price">NT$ {{ item.get_total|floatformat:0 }}</div>
            </div>
            {% endfor %}
          </div>
          
          <div class="order-total">
            <div class="total-row">
              <span>商品小計：</span>
              <span>NT$ {{ order.total_amount|floatformat:0 }}</span>
            </div>
            <div class="total-row">
              <span>運費：</span>
              <span>免運費</span>
            </div>
            <div class="total-row total-final">
              <span>訂單總計：</span>
              <span>NT$ {{ order.total_amount|floatformat:0 }}</span>
            </div>
          </div>
          
          {% if order.status == 'pending' %}
          <div class="payment-info">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>請注意：</strong>此訂單尚未付款。如需付款，請重新下單。
          </div>
          {% endif %}
          
          <div class="action-buttons">
            {% comment %}
            <!-- 移除立即付款功能，因為綠界同筆訂單編號只能下單一次 -->
            {% if order.status == 'pending' %}
              <a href="/api/v1/payment/checkout/{{ order.id }}/" class="btn-payment">
                <i class="bi bi-credit-card"></i> 立即付款
              </a>
            {% elif order.status == 'paid' %}
            {% endcomment %}
            
            {% if order.status == 'paid' %}
              <div class="alert-info">
                <i class="bi bi-check-circle"></i>
                付款已完成，我們將盡快為您處理訂單。
              </div>
            {% endif %}

            <a href="{% url 'cart:cart_detail' %}" class="btn-secondary">
              <i class="bi bi-cart"></i> 返回購物車
            </a>
            
            <a href="/" class="btn-secondary">
              <i class="bi bi-house"></i> 返回首頁
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
    </section>

</main>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 如果是剛創建的訂單，顯示成功訊息
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('created') === 'true') {
        showNotification('訂單創建成功！', 'success');
    }
});

// 通知函數
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // 3秒後自動移除
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
