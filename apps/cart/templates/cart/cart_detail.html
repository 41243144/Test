{% extends "base.html" %}
{% load static %}

{% block body_class %}cart-page{% endblock %}

{% block extra_css %}
  <style>
    /* 購物車頁面專屬樣式 */
    
    /* 頁面標題區域 */
    .cart-hero {
      background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('{% static "assets/img/page-title-bg.webp" %}');
      background-size: cover;
      background-position: center;
      padding: 120px 0 80px 0;
    }

    /* 購物車表格 */
    .cart-table {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .cart-table th {
      background: rgba(205, 164, 94, 0.2);
      color: #cda45e;
      font-weight: bold;
      border: none;
      padding: 15px;
    }

    .cart-table td {
      background: rgba(255,255,255,0.03);
      border: none;
      padding: 15px;
      vertical-align: middle;
    }

    .cart-table tbody tr {
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .cart-table tbody tr:hover {
      background: rgba(255,255,255,0.08);
    }

    /* 商品圖片 */
    .product-image {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      overflow: hidden;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-image .no-image {
      width: 100%;
      height: 100%;
      background: rgba(205, 164, 94, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #cda45e;
      font-size: 2rem;
    }

    /* 商品資訊 */
    .product-info h6 {
      color: #cda45e;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .vendor-name {
      color: #999;
      font-size: 0.9rem;
    }

    .vendor-name a {
      color: #999;
      text-decoration: none;
    }

    .vendor-name a:hover {
      color: #cda45e;
    }

    /* 數量控制 */
    .quantity-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quantity-btn {
      background: rgba(205, 164, 94, 0.2);
      border: 1px solid rgba(205, 164, 94, 0.3);
      color: #cda45e;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .quantity-btn:hover {
      background: rgba(205, 164, 94, 0.4);
    }

    .quantity-input {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      text-align: center;
      width: 60px;
      padding: 5px;
      border-radius: 5px;
    }

    /* 價格顯示 */
    .price {
      color: #cda45e;
      font-weight: bold;
      font-size: 1.1rem;
    }

    /* 移除按鈕 */
    .btn-remove {
      background: transparent;
      border: 1px solid #dc3545;
      color: #dc3545;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .btn-remove:hover {
      background: #dc3545;
      color: #fff;
    }

    /* 購物車摘要 */
    .cart-summary {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(255,255,255,0.1);
      position: sticky;
      top: 100px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .summary-row:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 1.2rem;
      color: #cda45e;
      margin-top: 10px;
      padding-top: 15px;
      border-top: 2px solid rgba(205, 164, 94, 0.3);
    }

    /* 按鈕樣式 */
    .btn-checkout {
      background: linear-gradient(135deg, #cda45e 0%, #b8935a 100%);
      border: none;
      color: white;
      padding: 15px 30px;
      border-radius: 30px;
      font-weight: bold;
      transition: all 0.3s ease;
      width: 100%;
      font-size: 1.1rem;
      margin-top: 20px;
    }

    .btn-checkout:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(205, 164, 94, 0.3);
      color: white;
    }

    .btn-continue-shopping {
      background: transparent;
      border: 2px solid #cda45e;
      color: #cda45e;
      padding: 12px 25px;
      border-radius: 25px;
      font-weight: bold;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin-right: 15px;
    }

    .btn-continue-shopping:hover {
      background: #cda45e;
      color: #fff;
    }

    .btn-clear-cart {
      background: transparent;
      border: 1px solid #dc3545;
      color: #dc3545;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .btn-clear-cart:hover {
      background: #dc3545;
      color: #fff;
    }

    /* 空購物車 */
    .empty-cart {
      text-align: center;
      padding: 60px 0;
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .empty-cart-icon {
      font-size: 4rem;
      color: #cda45e;
      margin-bottom: 20px;
    }

    /* 載入動畫 */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* 響應式設計 */
    @media (max-width: 768px) {
      .cart-table {
        font-size: 0.9rem;
      }
      
      .product-image {
        width: 60px;
        height: 60px;
      }
      
      .quantity-control {
        flex-direction: column;
        gap: 5px;
      }
      
      .btn-checkout {
        margin-top: 15px;
      }
    }
  </style>
{% endblock extra_css %}

{% block content %}
<main class="main">
    <!-- Page Title -->
    <div class="page-title cart-hero position-relative" data-aos="fade">
      <div class="container position-relative">
        <h1 class="text-light text-center">購物車</h1>
        <p class="text-center text-light fs-5">檢視您選購的商品</p>
        <nav class="breadcrumbs">
          <ol>
            <li><a href="/">首頁</a></li>
            <li class="current">購物車</li>
          </ol>
        </nav>
      </div>
    </div><!-- End Page Title -->

    <!-- 購物車內容 -->
    <section class="section py-5">
      <div class="container">
        
        {% if cart_items %}
        <div class="row">
          <!-- 購物車商品列表 -->
          <div class="col-lg-8" data-aos="fade-right">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h4 class="text-light">購物車商品 ({{ total_items }} 件)</h4>
              <a href="#" class="btn-clear-cart" onclick="clearCart()">
                <i class="bi bi-trash"></i> 清空購物車
              </a>
            </div>
            
            <div class="cart-table">
              <table class="table table-dark mb-0">
                <thead>
                  <tr>
                    <th>商品</th>
                    <th>單價</th>
                    <th>數量</th>
                    <th>小計</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in cart_items %}
                  <tr class="cart-item" data-product-id="{% if user.is_authenticated %}{{ item.product.id }}{% else %}{{ item.product.id }}{% endif %}">
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="product-image me-3">
                          {% if user.is_authenticated %}
                            {% if item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                            {% else %}
                            <div class="no-image">
                              <i class="bi bi-image"></i>
                            </div>
                            {% endif %}
                          {% else %}
                            {% if item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                            {% else %}
                            <div class="no-image">
                              <i class="bi bi-image"></i>
                            </div>
                            {% endif %}
                          {% endif %}
                        </div>
                        <div class="product-info">
                          <h6>
                            {% if user.is_authenticated %}
                              {{ item.product.name }}
                            {% else %}
                              {{ item.product.name }}
                            {% endif %}
                          </h6>
                          <div class="vendor-name">
                            <i class="bi bi-shop"></i>
                            {% if user.is_authenticated %}
                              <a href="{% url 'home:vendor_products' item.product.vendor.id %}">{{ item.product.vendor.name }}</a>
                            {% else %}
                              <a href="{% url 'home:vendor_products' item.product.vendor.id %}">{{ item.product.vendor.name }}</a>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="price">
                        {% if user.is_authenticated %}
                          NT$ {{ item.price|floatformat:0 }}
                        {% else %}
                          NT$ {{ item.price|floatformat:0 }}
                        {% endif %}
                      </span>
                    </td>
                    <td>
                      <div class="quantity-control">
                        <button class="quantity-btn" onclick="updateQuantity(this, -1)">-</button>
                        <input type="number" class="quantity-input" 
                               value="{% if user.is_authenticated %}{{ item.quantity }}{% else %}{{ item.quantity }}{% endif %}" 
                               min="1" 
                               onchange="updateQuantityDirect(this)">
                        <button class="quantity-btn" onclick="updateQuantity(this, 1)">+</button>
                      </div>
                    </td>
                    <td>
                      <span class="price item-total">
                        {% if user.is_authenticated %}
                          NT$ {{ item.total_price|floatformat:0 }}
                        {% else %}
                          NT$ {{ item.total_price|floatformat:0 }}
                        {% endif %}
                      </span>
                    </td>
                    <td>
                      <button class="btn-remove" onclick="removeItem(this)" title="移除商品">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <div class="mt-4">
              <a href="{% url 'home:cooperative_farmers' %}" class="btn-continue-shopping">
                <i class="bi bi-arrow-left"></i> 繼續購物
              </a>
            </div>
          </div>

          <!-- 購物車摘要 -->
          <div class="col-lg-4" data-aos="fade-left">
            <div class="cart-summary">
              <h5 class="text-light mb-4">訂單摘要</h5>
              
              <div class="summary-row">
                <span class="text-light">商品總數：</span>
                <span class="text-light" id="summary-items">{{ total_items }} 件</span>
              </div>
              
              <div class="summary-row">
                <span class="text-light">商品小計：</span>
                <span class="text-light" id="summary-subtotal">NT$ {{ total_price|floatformat:0 }}</span>
              </div>
              
              <div class="summary-row">
                <span class="text-light">運費：</span>
                <span class="text-light">免運費</span>
              </div>
              
              <div class="summary-row">
                <span>總計：</span>
                <span id="summary-total">NT$ {{ total_price|floatformat:0 }}</span>
              </div>
              
              <button class="btn-checkout" onclick="checkout()">
                <i class="bi bi-credit-card"></i> 立即付款
              </button>
              
              <div class="mt-3 text-center">
                <small class="text-muted">
                  <i class="bi bi-shield-check"></i>
                  安全付款，資料加密保護
                </small>
              </div>
            </div>
          </div>
        </div>
        
        {% else %}
        <!-- 空購物車 -->
        <div class="empty-cart" data-aos="fade-up">
          <div class="empty-cart-icon">
            <i class="bi bi-cart-x"></i>
          </div>
          <h4 class="text-light mb-3">您的購物車是空的</h4>
          <p class="text-light mb-4">快去逛逛我們的優質農產品吧！</p>
          <a href="{% url 'home:cooperative_farmers' %}" class="btn btn-warning">
            <i class="bi bi-shop"></i> 開始購物
          </a>
        </div>
        {% endif %}

      </div>
    </section>

</main>

<!-- 載入遮罩 -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
    <div class="spinner-border text-warning" role="status">
      <span class="visually-hidden">載入中...</span>
    </div>
    <p class="mt-2">處理中，請稍候...</p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化 AOS 動畫
    if (typeof AOS !== 'undefined') {
        AOS.init({
            duration: 1000,
            easing: 'ease-in-out',
            once: true
        });
    }
});

// 顯示載入遮罩
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'block';
}

// 隱藏載入遮罩
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// 更新商品數量
function updateQuantity(button, change) {
    const row = button.closest('.cart-item');
    const input = row.querySelector('.quantity-input');
    const currentQuantity = parseInt(input.value);
    const newQuantity = Math.max(1, currentQuantity + change);
    
    input.value = newQuantity;
    updateCartItem(row, newQuantity);
}

// 直接更新數量
function updateQuantityDirect(input) {
    const row = input.closest('.cart-item');
    const quantity = Math.max(1, parseInt(input.value) || 1);
    input.value = quantity;
    updateCartItem(row, quantity);
}

// 更新購物車項目
function updateCartItem(row, quantity) {
    showLoading();
    
    const productId = row.dataset.productId;
    
    fetch('{% url "cart:update_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: quantity
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            // 更新該項目的小計
            const price = parseFloat(row.querySelector('.price').textContent.replace('NT$ ', '').replace(',', ''));
            const itemTotal = row.querySelector('.item-total');
            itemTotal.textContent = `NT$ ${(price * quantity).toLocaleString()}`;
            
            // 更新摘要
            updateCartSummary(data.total_items, data.total_price);
            
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('更新失敗，請稍後再試', 'error');
    });
}

// 移除商品
function removeItem(button) {
    if (!confirm('確定要移除此商品嗎？')) {
        return;
    }
    
    showLoading();
    
    const row = button.closest('.cart-item');
    const productId = row.dataset.productId;
    
    fetch('{% url "cart:remove_from_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({
            product_id: productId
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            // 移除該行
            row.remove();
            
            // 更新摘要
            updateCartSummary(data.total_items, data.total_price);
            
            // 如果購物車為空，重新載入頁面
            if (data.total_items === 0) {
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
            
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('移除失敗，請稍後再試', 'error');
    });
}

// 清空購物車
function clearCart() {
    if (!confirm('確定要清空購物車嗎？此操作無法復原。')) {
        return;
    }
    
    showLoading();
    
    fetch('{% url "cart:clear_cart" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.message || '清空失敗', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('清空失敗，請稍後再試', 'error');
    });
}

// 更新購物車摘要
function updateCartSummary(totalItems, totalPrice) {
    document.getElementById('summary-items').textContent = `${totalItems} 件`;
    document.getElementById('summary-subtotal').textContent = `NT$ ${totalPrice.toLocaleString()}`;
    document.getElementById('summary-total').textContent = `NT$ ${totalPrice.toLocaleString()}`;
}

// 前往結帳
function checkout() {
    if (!{% if user.is_authenticated %}true{% else %}false{% endif %}) {
        showNotification('請先登入後再進行結帳', 'error');
        setTimeout(() => {
            window.location.href = '/accounts/login/?next=' + encodeURIComponent(window.location.pathname);
        }, 1500);
        return;
    }
    
    // 檢查購物車是否為空
    const cartItems = document.querySelectorAll('.cart-item');
    if (cartItems.length === 0) {
        showNotification('購物車是空的，無法結帳', 'error');
        return;
    }
    
    showLoading();
    
    // 準備結帳資料
    const items = [];
    cartItems.forEach(item => {
        const productId = item.dataset.productId;
        const quantity = parseInt(item.querySelector('.quantity-input').value);
        items.push({
            product_id: parseInt(productId),
            quantity: quantity
        });
    });
    
    // 發送結帳請求到 order API
    fetch('/api/v1/order/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({
            items: items
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        hideLoading();
        if (data.order_id) {
            showNotification('訂單創建成功！正在導向付款頁面...', 'success');
            
            // 清空購物車
            clearCartAfterOrder();
            
            // 導向付款頁面
            setTimeout(() => {
                window.location.href = `/api/v1/payment/checkout/${data.order_id}/`;
            }, 1500);
        } else {
            showNotification(data.error || '結帳失敗，請稍後再試', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('結帳錯誤:', error);
        showNotification('結帳失敗，請稍後再試', 'error');
    });
}

// 結帳後清空購物車
function clearCartAfterOrder() {
    fetch('{% url "cart:clear_cart" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        }
    })
    .catch(error => {
        console.error('清空購物車失敗:', error);
    });
}

// 獲取 CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 顯示通知
function showNotification(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} notification-toast`;
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 9999;
        animation: slideInRight 0.3s ease-out;
        min-width: 300px;
    `;
    notification.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <span>${message}</span>
            <button type="button" class="btn-close ms-2" aria-label="Close"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // 關閉按鈕功能
    notification.querySelector('.btn-close').addEventListener('click', function() {
        notification.remove();
    });
    
    // 自動移除
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// CSS 動畫樣式
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>

{% endblock content %}
